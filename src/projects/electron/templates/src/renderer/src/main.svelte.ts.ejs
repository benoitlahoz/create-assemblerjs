import { AbstractAssemblage, Assemblage, Assembler, Context, AssemblerContext } from 'assemblerjs';
import { Task } from '@assemblerjs/core';
import { router } from '@/windows/router';
import App from './App.svelte';
import { setContext } from 'svelte';
import { ASSEMBLER_CONTEXT_KEY } from '@/renderer/constants/injection.keys';

@Assemblage()
class MainApp implements AbstractAssemblage {
  private app: App | null = null;

  constructor(@Context() private context: AssemblerContext) {}

  public async onInit(): Promise<void> {
    const target = document.getElementById('app');
    if (!target) {
      throw new Error('Root element not found');
    }

    // Set context before creating the app
    // Note: In Svelte, setContext must be called during component initialization
    // The context will be passed through the App component props
    this.app = new App({
      target,
      props: {
        router: router,
        assemblerContext: this.context
      }
    });
    console.log('Svelte Router initialized');
  }
}

const task = Task.of(() => Assembler.build(MainApp));
task
  .fork()
  .then(() => {
    console.log('Svelte app was successfully built and mounted.');
  })
  .catch((error) => {
    console.error('There was an error during Svelte app build:', error);
  });
